# Domain is read from environment variable DOMAIN passed by docker-compose.
{$DOMAIN} {
  encode zstd gzip

  # This project: keep prefix /video-analysis -> api:8000 (for FastAPI root_path)
  handle /video-analysis* {
    reverse_proxy api:8000 {
      transport http {
        dial_timeout 10s
        read_timeout 600s
        write_timeout 600s
      }
      header_up Host {host}
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
      header_up X-Forwarded-Prefix /video-analysis
    }
  }

  # Email Assistant at /email-assistant -> email_assistant:5000
  # Use handle_path to strip prefix so backend continues to serve /api/* and /oauth/*
  handle_path /email-assistant* {
    reverse_proxy email_assistant:5000 {
      transport http {
        dial_timeout 10s
        read_timeout 600s
        write_timeout 600s
      }
      header_up Host {host}
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
    }
  }



  # Default handler
  handle {
    respond "Not Found" 404
  }
}

# 步骤 A：DNS 与基础环境（必须先做）

1. 在域名服务商添加解析（把 `your-domain.com` 换成你的域名、`X.X.X.X` 换成服务器公网IP）

- A 记录：`mail` → `X.X.X.X`
- 如果用 Cloudflare：**暂时切到 “DNS only”（灰云）**，等证书签好再开橙云。

1. 服务器初始化

```
sudo apt update && sudo apt -y upgrade
sudo timedatectl set-timezone Asia/Shanghai  # 或你的时区
```

------

# 步骤 B：防火墙（UFW）

```
sudo apt -y install ufw
sudo ufw allow OpenSSH
sudo ufw allow http
sudo ufw allow https
sudo ufw --force enable
sudo ufw status
```

------

# 步骤 C：安装 Nginx 并反代到你的应用（:5000）

1. 安装 Nginx

```
sudo apt -y install nginx
sudo systemctl enable --now nginx
```

1. 创建站点配置（把 `mail.your-domain.com` 换成你的真实域名）

```
sudo tee /etc/nginx/sites-available/mail.your-domain.com > /dev/null <<'CONF'
server {
    listen 80;
    listen [::]:80;
    server_name mail.your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
CONF

sudo ln -s /etc/nginx/sites-available/mail.your-domain.com /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl reload nginx
```

> 现在，用 `http://mail.your-domain.com` 访问会被反代到你本机 5000 端口（暂时未上 HTTPS）。

------

# 步骤 D：申请并自动配置 HTTPS（Let’s Encrypt via snap）

1. 安装 certbot（snap 方式）

```
sudo snap install core; sudo snap refresh core
sudo snap install --classic certbot
sudo ln -s /snap/bin/certbot /usr/bin/certbot
```

1. 申请证书并自动改写 Nginx（选择“强制HTTPS”）

```
sudo certbot --nginx -d mail.your-domain.com
```

1. 检查自动续期

```
systemctl list-timers | grep certbot
sudo certbot renew --dry-run
```

> **如用 Cloudflare 橙云**：签发前务必“DNS only”。成功后可再打开橙云（HTTP-01 已完成）。

------

# 步骤 E：在你的项目里实现两个最基本的 OAuth 路由

以常见后端为例（你用什么框架告诉我，我可以给你框架版现成代码）：

- **发起授权**（例如 `GET /auth/google`）：重定向到 Google 的授权页，带上 `redirect_uri`（就是下一条里的回调地址）、`scope`（Gmail API 需要的作用域）、`state`（CSRF 防护）
- **处理回调**（例如 `GET /oauth2/callback`）：从查询参数里接收 `code`，再向 Google 交换 `access_token` 和 `refresh_token`，保存到你的数据库/密钥库

> 建议的**回调路径**：

```
https://mail.your-domain.com/oauth2/callback
```

或：

```
https://mail.your-domain.com/oauth2/callback/google
```

**注意**：路径区分大小写；不要带 `#` 片段；不要用通配符；必须是 **https**，不能是公网 IP，不能是相对路径。

------

# 步骤 F：在 Google Cloud Console 正确填写

1. 打开：**APIs & Services → Credentials → CREATE CREDENTIALS → OAuth client ID**

   - Application type 选 **Web application**

2. **Authorized redirect URIs** 填写你刚才确定的回调，例如：

   ```
   https://mail.your-domain.com/oauth2/callback
   ```

3. （可选）**Authorized JavaScript origins** 仅当你的前端在浏览器里直接发起 OAuth（隐式/PKCE）才需要，比如：

   ```
   https://mail.your-domain.com
   ```

4. 保存后会得到 **Client ID** 和 **Client Secret**

   - 放进你的应用配置（环境变量），**不要提交到仓库**

   - 例：`.env`

     ```
     GOOGLE_CLIENT_ID=xxxxxxxx.apps.googleusercontent.com
     GOOGLE_CLIENT_SECRET=xxxxxxxx
     GOOGLE_REDIRECT_URI=https://mail.your-domain.com/oauth2/callback
     ```

5. **OAuth 同意屏幕**（APIs & Services → OAuth consent screen）

   - 模式先用 **Testing**（测试模式），把你自己的 Google 账号加到 Test users
   - 使用 Gmail API 的敏感/受限作用域（如 `gmail.readonly`、`gmail.modify`、`gmail.send`），超出基础资料时，最终发布给公众前需要**提交验证**，并在隐私政策页说明用途（你的网站需要能访问）。

------

# 步骤 G：端到端自测清单

- `curl -I https://mail.your-domain.com` 返回 `200/301`，证书链正确
- 打开 `https://mail.your-domain.com/auth/google`（或你的发起授权页面）→ 能跳转到 Google 登录授权
- 授权后回到 `https://mail.your-domain.com/oauth2/callback?...code=...` → 你的后端能换到 `access_token/refresh_token`
- 用 token 成功调用一次 Gmail API（例如拉取标签列表），确认权限 OK

------

## 常见坑排查

- **证书申请失败**：DNS 未生效；80 未放行；Cloudflare 仍是橙云；Nginx 站点 `server_name` 不匹配域名
- **重定向URI不被接受**：不是 https；带了通配符/片段；与代码里实际 `redirect_uri` 不一致；用的是 IP
- **回调 404**：Nginx 反代到的端口没跑；路由路径名不一致；大小写不一致
- **Gmail API 403**：作用域未启用/未同意；Test users 未包含你的账号；项目未打开对应 API

------

如果你把这三项告诉我：

1. 你的真实域名（可打码）
2. 你用的后端框架（Flask/Django/FastAPI/Express/Next 等）
3. 你打算用的作用域（只读/读写/发送）

我马上给你**可直接粘贴的 Nginx 配置**和**对应框架的回调示例代码**（含 token 交换与最小化的 Gmail API 调用），以及**Google 控制台的精确填写示例**。

##### 
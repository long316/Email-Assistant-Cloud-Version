# 邮件助手使用说明

## 概述

这是一个基于Gmail API的自动邮件发送助手，支持从Excel文件中读取邮箱列表并按照指定条件批量发送邮件。

## 主要功能

1. **多邮箱认证管理** - 支持为不同的Gmail邮箱进行OAuth认证
2. **Excel文件处理** - 读取并过滤Excel中的邮箱数据
3. **智能发送调度** - 随机间隔发送，避免被标记为垃圾邮件
4. **状态自动更新** - 发送成功/失败后自动更新Excel文件状态
5. **多种使用方式** - 支持命令行脚本和API接口两种方式

## 安装和配置

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置Gmail API

1. 在[Google Cloud Console](https://console.cloud.google.com/)创建项目
2. 启用Gmail API
3. 创建OAuth 2.0客户端凭据（桌面应用类型）
4. 下载凭据文件并重命名为`credentials.json`，放在项目根目录

### 3. 准备Excel文件

Excel文件必须包含以下列：
- `邮箱` - 收件人邮箱地址
- `合作次数` - 合作次数
- `回复次数` - 回复次数
- `跟进次数` - 跟进次数
- `跟进方式` - 跟进方式
- `是否已邮箱建联` - 建联状态（程序会自动更新此列）
- `语言` - 邮件语言（新增，如：English、Spanish）

**模板功能所需的额外列：**
根据模板中使用的参数添加对应列，例如：
- `某条视频内容总结` - 用于个性化主题
- `达人ID` - 收件人的标识
- `钩子` - 个性化开场白

### 4. 准备邮件模板（新功能）

在项目的 `template/` 目录下创建模板文件：

**模板文件命名规则：**
- 主题模板：`{语言代码}-subject`
- HTML内容模板：`{语言代码}-html_content`

**支持的语言代码：**
- English → en
- Spanish → esp
- French → fr
- German → de
- Chinese → zh
- Japanese → ja

**模板参数格式：**
在模板中使用 `[参数名]` 格式的占位符，系统会自动从Excel数据中替换。

**示例模板：**

`template/en-subject`:
```
Loved your [某条视频内容总结] video and a partnership idea!
```

`template/en-html_content`:
```html
<p>Hi [达人ID],</p>
<p>[钩子]</p>
<p>I'm Erica, founder of Swipe Up US (Outdoor Living & Essentials)...</p>
<div style="text-align: center;">
    <img id="logo" alt="Company Logo" />
</div>
```

### 5. 图片功能（新增）

系统现在支持在邮件中插入内联图片，实现更丰富的邮件内容。

**图片存放位置：**
将图片文件放在项目根目录的 `files/pics/` 目录下。

**支持的图片格式：**
- JPG/JPEG
- PNG
- GIF
- BMP
- WebP

**图片大小限制：**
单个图片文件最大不超过25MB（Gmail附件限制）

**在HTML模板中使用图片：**
在HTML内容模板中使用 `<img id="图片文件名" />` 标识：

```html
<!-- 引用 files/pics/logo.png -->
<img id="logo" alt="Logo" style="max-width: 300px;" />

<!-- 引用 files/pics/product.jpg -->
<img id="product" alt="Product Image" />
```

**图片处理机制：**
1. 系统自动扫描HTML内容中的 `<img id="xxx" />` 标识
2. 根据ID在 `files/pics/` 目录中查找对应的图片文件
3. 将图片作为内联附件添加到邮件中
4. 自动转换 `<img id="xxx" />` 为 `<img src="cid:image_xxx" />`

**错误处理：**
- 如果图片文件不存在，系统会记录错误但继续发送邮件
- 图片格式不支持或文件过大时会跳过该图片
- 详细的错误信息会记录在日志中

**示例模板文件：**
`template/en-html_content_with_image`:
```html
<p>Hi [达人ID],</p>
<p>[钩子]</p>

<div style="text-align: center; margin: 20px 0;">
    <img id="logo" alt="Swipe Up US Logo" style="max-width: 300px; height: auto;" />
</div>

<p>I loved your video about [某条视频内容总结]!</p>
<p>Best regards,<br>Erica</p>
```

### 6. 文件附件功能（新增）

系统现在支持在邮件中添加文件附件，实现更丰富的邮件内容。

**附件存放位置：**
将附件文件放在项目根目录的 `files/` 目录下（注意：图片文件放在 `files/pics/` 子目录）。

**支持的文件格式：**
- **文档类型**：PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX
- **文本类型**：TXT, CSV, RTF
- **压缩文件**：ZIP, RAR, 7Z
- **数据格式**：JSON, XML

**文件大小限制：**
- 单个文件最大不超过25MB（Gmail附件限制）
- 所有附件总大小不超过25MB

**在API中使用附件：**
在API调用时，通过 `attachments` 参数指定要附加的文件列表：

```json
{
  "sender_email": "your@gmail.com",
  "excel_file_path": "data.xlsx",
  "attachments": ["product_catalog.pdf", "price_list.xlsx", "company_intro"]
}
```

**附件处理机制：**
1. 系统根据文件ID在 `files/` 目录中查找对应文件
2. 支持带扩展名（如 `catalog.pdf`）或不带扩展名（如 `catalog`）的文件ID
3. 不带扩展名时，系统自动查找匹配的支持格式文件
4. 将文件作为MIME附件添加到邮件中
5. 自动检测MIME类型并设置正确的Content-Type

**错误处理：**
- 文件不存在时会记录错误并跳过该附件
- 文件格式不支持或文件过大时会跳过该文件
- 详细的错误信息会记录在日志中
- 即使附件处理失败，邮件仍会正常发送（不含附件）

**目录结构示例：**
```
files/
├── pics/                    # 图片文件（用于邮件内嵌）
│   ├── logo.png
│   └── product.jpg
├── product_catalog.pdf       # 产品目录（附件）
├── price_list.xlsx          # 价格表（附件）
├── company_intro.docx       # 公司介绍（附件）
└── terms_of_service.pdf     # 服务条款（附件）
```

### 7. 筛选条件

程序会自动筛选满足以下条件的邮箱：
- `邮箱` != NULL
- `合作次数` == 0
- `回复次数` == 0
- `跟进次数` == 1
- `跟进方式` != "手动"

## 使用方式

**注意：现在所有邮件发送都自动支持图片和附件功能，无需额外配置。**

**重要提醒：**
- 图片功能：在HTML内容中自动生效，使用 `<img id="文件名" />` 标识
- 附件功能：仅通过API接口支持，命令行暂不支持（即将支持）

### 方式一：命令行脚本

#### 基本用法

```bash
# 使用模板发送邮件（推荐）
python email_script.py --sender your@gmail.com --excel data.xlsx --use-templates

# 使用固定内容发送邮件（传统方式）
python email_script.py --sender your@gmail.com --excel data.xlsx

# 预览待发送邮箱列表
python email_script.py --sender your@gmail.com --excel data.xlsx --preview

# 预览模板邮件内容
python email_script.py --sender your@gmail.com --excel data.xlsx --preview-templates

# 显示统计信息
python email_script.py --sender your@gmail.com --excel data.xlsx --stats
```

#### 高级参数

```bash
# 模板方式发送（推荐）
python email_script.py \
  --sender your@gmail.com \
  --excel data.xlsx \
  --use-templates \
  --start-time "2024-01-01 09:00:00" \
  --min-interval 30 \
  --max-interval 120

# 传统方式发送
python email_script.py \
  --sender your@gmail.com \
  --excel data.xlsx \
  --subject "邮件主题" \
  --content "邮件内容" \
  --start-time "2024-01-01 09:00:00" \
  --min-interval 30 \
  --max-interval 120
```

#### 参数说明

- `--sender`: 发件人邮箱地址（必需）
- `--excel`: Excel文件路径（必需）
- `--credentials`: OAuth凭据文件路径（默认：credentials.json）
- `--use-templates`: 使用模板发送邮件（推荐）
- `--subject`: 邮件主题（传统模式下可选，有默认值）
- `--content`: 邮件内容（传统模式下可选，有默认值）
- `--html-content`: HTML邮件内容（传统模式下可选）
- `--start-time`: 开始发送时间（可选，格式：YYYY-MM-DD HH:MM:SS）
- `--min-interval`: 最小发送间隔秒数（默认：20）
- `--max-interval`: 最大发送间隔秒数（默认：90）
- `--preview`: 仅预览待发送邮箱列表
- `--preview-templates`: 预览模板邮件内容
- `--stats`: 显示统计信息

### 方式二：API接口

#### API服务器文件结构说明

项目中有两个API服务器相关的文件，作用不同：

1. **`api_server.py`（根目录）** - **推荐使用的启动入口**
   - 作用：项目的API服务器启动脚本
   - 职责：设置Python路径，导入核心模块，处理命令行参数
   - 使用方式：`python api_server.py [参数]`

2. **`src/api_server.py`（src目录）** - 核心实现模块
   - 作用：包含所有API端点的具体实现逻辑
   - 职责：Flask应用配置、路由定义、请求处理、错误处理
   - 通常不直接调用，由根目录的启动脚本导入使用

#### 启动API服务器

**推荐使用根目录的启动脚本：**

```bash
# 基本启动
python api_server.py

# 自定义地址和端口
python api_server.py --host 127.0.0.1 --port 5000

# 启用调试模式
python api_server.py --host 127.0.0.1 --port 5000 --debug
```

**启动参数说明：**
- `--host`: 服务器绑定地址（默认：127.0.0.1）
- `--port`: 服务器端口号（默认：5000）
- `--debug`: 启用Flask调试模式（默认：关闭）

**启动成功后，服务器会显示所有可用的API端点列表，方便开发调试。**

#### API接口说明

**服务器启动后提供13个API端点，分为以下几类：**

**基础功能接口（1-10）：**

**1. 健康检查**
```
GET /api/health
```

**2. 认证邮箱**
```
POST /api/authenticate
Content-Type: application/json

{
  "sender_email": "your@gmail.com"
}
```

**3. 验证Excel文件**
```
POST /api/validate_excel
Content-Type: application/json

{
  "excel_file_path": "data.xlsx"
}
```

**4. 预览邮箱列表**
```
POST /api/preview
Content-Type: application/json

{
  "excel_file_path": "data.xlsx"
}
```

**5. 发送邮件（支持附件）**
```
POST /api/send_emails
Content-Type: application/json

{
  "sender_email": "your@gmail.com",
  "excel_file_path": "data.xlsx",
  "subject": "邮件主题（可选）",
  "content": "邮件内容（可选）",
  "html_content": "HTML内容（可选）",
  "attachments": ["product_catalog.pdf", "price_list.xlsx"],
  "start_time": "2024-01-01T09:00:00（可选）",
  "min_interval": 20,
  "max_interval": 90
}
```

**6. 获取发送状态**
```
GET /api/status
```

**7. 暂停发送**
```
POST /api/pause
```

**8. 恢复发送**
```
POST /api/resume
```

**9. 停止发送**
```
POST /api/stop
```

**10. 获取统计信息**
```
POST /api/statistics
Content-Type: application/json

{
  "excel_file_path": "data.xlsx"
}
```

**模板功能接口（11-13）：**

**11. 验证模板兼容性**
```
POST /api/validate_templates
Content-Type: application/json

{
  "excel_file_path": "data.xlsx"
}
```

**12. 预览模板邮件**
```
POST /api/preview_template_emails
Content-Type: application/json

{
  "excel_file_path": "data.xlsx",
  "max_previews": 3
}
```

**13. 发送模板邮件（支持附件）**
```
POST /api/send_template_emails
Content-Type: application/json

{
  "sender_email": "your@gmail.com",
  "excel_file_path": "data.xlsx",
  "attachments": ["product_catalog.pdf", "price_list"],
  "start_time": "2024-01-01T09:00:00（可选）",
  "min_interval": 20,
  "max_interval": 90
}
```

## 工作流程

### 传统模式工作流程
1. **邮箱认证** - 首次使用某个发件邮箱时需要进行OAuth认证
2. **文件验证** - 验证Excel文件格式和必需列
3. **数据筛选** - 根据指定条件筛选待发送邮箱
4. **计划发送** - 可选择立即发送或定时发送
5. **批量发送** - 按照随机间隔依次发送邮件
6. **状态更新** - 发送成功设置为1，失败设置为-1

### 模板模式工作流程（推荐）
1. **邮箱认证** - 首次使用某个发件邮箱时需要进行OAuth认证
2. **文件验证** - 验证Excel文件格式和必需列
3. **模板验证** - 检查模板文件存在性和参数兼容性
4. **数据筛选** - 根据指定条件筛选待发送邮箱
5. **内容生成** - 根据每行数据和对应语言生成个性化邮件内容
6. **计划发送** - 可选择立即发送或定时发送
7. **批量发送** - 按照随机间隔依次发送个性化邮件
8. **状态更新** - 发送成功设置为1，失败设置为-1

## 注意事项

1. **首次认证** - 每个邮箱首次使用时会弹出浏览器进行OAuth认证
2. **发送限制** - Gmail API有每日发送限制，建议合理控制发送数量
3. **间隔设置** - 建议设置适当的发送间隔，避免触发反垃圾邮件机制
4. **文件备份** - 建议在批量发送前备份Excel文件
5. **网络稳定** - 确保网络连接稳定，避免发送过程中断
6. **模板准备** - 使用模板功能前确保模板文件已正确创建
7. **参数匹配** - 确保Excel列名与模板参数完全匹配
8. **语言设置** - Excel中的语言列值必须与支持的语言名称匹配

## 日志记录

- 日志文件保存在`logs/`目录下
- 文件名格式：`email_assistant_YYYYMMDD.log`
- 包含详细的发送过程和错误信息

## 故障排除

### API服务器问题
- **无法启动服务器**: 检查端口是否被占用，尝试使用其他端口
- **导入模块错误**: 确保使用根目录的`api_server.py`启动，而不是`src/api_server.py`
- **路径相关错误**: 确保在项目根目录下执行启动命令
- **API调用失败**: 检查服务器是否正常启动，查看控制台输出的错误信息

### 认证问题
- 确保`credentials.json`文件正确
- 检查Gmail API是否已启用
- 重新下载并配置OAuth凭据

### Excel文件问题
- 确保文件包含所有必需列
- 检查列名是否完全匹配
- 确保文件未被其他程序占用
- 检查语言列的值是否正确
- 验证模板参数对应的列是否存在

### 图片和附件问题
- **图片问题**：
  - 确保 `files/pics/` 目录存在且包含所需图片
  - 检查图片文件格式是否支持（JPG/PNG/GIF/BMP/WebP）
  - 验证图片文件大小不超过25MB
  - 确认HTML模板中的 `<img id="xxx" />` 标识正确
- **附件问题**：
  - 确保 `files/` 目录存在且包含所需附件
  - 检查附件文件格式是否支持（PDF/DOC/Excel等）
  - 验证单个文件和总附件大小不超过25MB
  - 确认API调用中的 `attachments` 参数格式正确
  - 检查文件ID是否与实际文件名匹配

### 模板相关问题
- 确保template/目录存在且包含所需的模板文件
- 检查模板文件命名是否正确（如：en-subject, esp-html_content）
- 验证模板中的参数名与Excel列名完全匹配
- 确保模板文件编码为UTF-8

### 发送失败
- 检查网络连接
- 确认发件邮箱配置正确
- 查看日志文件了解具体错误信息

## 综合功能使用示例

### Excel数据示例
```
邮箱                   | 语言    | 某条视频内容总结          | 达人ID        | 钩子
test@example.com       | English | outdoor camping tips      | OutdoorGuru   | Love your content!
ejemplo@correo.com     | Spanish | consejos de camping       | CampingPro    | ¡Excelente trabajo!
```

### 完整邮件内容示例

使用模板 + 图片 + 附件的完整邮件：

**API调用：**
```json
{
  "sender_email": "your@gmail.com",
  "excel_file_path": "data.xlsx",
  "attachments": ["product_catalog.pdf", "price_list.xlsx"]
}
```

**生成的英语邮件：**
- **主题**：`Loved your outdoor camping tips video and a partnership idea!`
- **HTML内容**：包含个性化文本 + Logo图片 + 产品图片
- **附件**：产品目录PDF + 价格表Excel
- **MIME结构**：multipart/mixed > multipart/related > multipart/alternative

**生成的西语邮件：**
- **主题**：`Me encantó tu video sobre consejos de camping y tengo una idea de colaboración!`
- **HTML内容**：包含西语个性化文本 + 相同的图片
- **附件**：相同的文件附件

### 邮件结构说明

最终生成的邮件包含以下完整结构：
1. **纯文本版本**：HTML自动转换的文本内容
2. **HTML版本**：带样式的富文本内容
3. **内联图片**：Logo、产品图片等（Content-ID引用）
4. **文件附件**：PDF文档、Excel表格等

这种结构确保邮件在各种客户端中都能正确显示。

## 项目结构更新

### 新增文件和目录
```
D:\Email Assistant\
├── src/
│   ├── image_manager.py          # 图片文件管理模块 (新增)
│   ├── attachment_manager.py     # 文件附件管理模块 (新增)
│   └── template_manager.py       # 模板管理器 (已扩展支持图片)
├── files/                        # 文件存储目录 (新增)
│   ├── pics/                     # 图片文件目录 (新增)
│   │   ├── logo.png             # 示例：公司Logo
│   │   └── product.jpg          # 示例：产品图片
│   ├── product_catalog.pdf       # 示例：产品目录附件
│   ├── price_list.xlsx          # 示例：价格表附件
│   └── company_intro.docx       # 示例：公司介绍附件
├── template/
│   ├── en-html_content           # 英语HTML模板（支持图片和附件）
│   └── esp-html_content         # 西语HTML模板（支持图片和附件）
└── test/
    ├── test_image_features.py    # 图片功能测试脚本
    └── test_attachment_features.py # 附件功能测试脚本 (新增)
```

### 功能更新摘要
- ✅ **内联图片支持**: 邮件中可包含公司Logo、产品图片等
- ✅ **文件附件支持**: 邮件可携带PDF、DOC、Excel等多种格式文件
- ✅ **自动图片处理**: 系统自动识别HTML中的图片标识并处理
- ✅ **智能附件管理**: 自动检测文件格式、验证大小限制
- ✅ **多格式支持**: 图片支持JPG/PNG/GIF等，附件支持PDF/DOC/Excel等
- ✅ **错误容错**: 图片或附件缺失时不影响邮件正常发送
- ✅ **向后兼容**: 现有功能和API完全兼容，无需修改
- ✅ **性能优化**: 文件Base64编码缓存，避免重复处理
- ✅ **MIME结构优化**: 支持复杂邮件结构（文本+HTML+图片+附件）

### 使用图片和附件功能的方法

**使用图片功能：**
1. 将图片文件放入 `files/pics/` 目录
2. 在HTML模板中使用 `<img id="文件名" />` 引用图片
3. 正常发送邮件，系统自动处理图片附件

**使用文件附件功能：**
1. 将附件文件放入 `files/` 目录
2. 在API调用时通过 `attachments` 参数指定文件列表
3. 系统自动验证文件并添加到邮件中

**组合使用示例（API调用）：**
```json
{
  "sender_email": "your@gmail.com",
  "excel_file_path": "data.xlsx",
  "attachments": ["product_catalog.pdf", "price_list.xlsx"],
  "html_content": "<p>Hello!</p><img id='logo' alt='Logo' /><p>Please find attachments.</p>"
}
```

这样发送的邮件将包含：
- HTML内容
- 内联图片（logo）
- 文件附件（产品目录PDF + 价格表Excel）

## 技术支持

如有问题，请查看日志文件或联系技术支持。

## 版本更新记录

### v2.1 - 文件附件功能（2024年9月24日）
- ✅ 新增文件附件支持：PDF、DOC、Excel等多种格式
- ✅ 新增 `AttachmentManager` 模块管理文件附件
- ✅ API接口扩展：`attachments` 参数支持
- ✅ 智能文件验证：格式检测、大小限制
- ✅ 错误容错机制：附件缺失时邮件仍可发送

### v2.0 - 多语言模板与图片功能（2024年9月24日）
- ✅ 多语言模板系统：English、Spanish等
- ✅ 图片内嵌支持：HTML中的 `<img />` 标识自动处理
- ✅ 参数化模板：`[参数名]` 格式动态替换
- ✅ 新增 `ImageManager` 和 `TemplateManager` 模块
- ✅ 向后兼容：保持原有API和功能不变

### v1.0 - 基础邮件发送功能
- ✅ Gmail API集成
- ✅ Excel数据处理
- ✅ 批量邮件发送
- ✅ 智能调度系统